FROM python:3.12-slim-bookworm
LABEL maintainer="choa.james@gmail.com"

ENV LC_ALL=C.UTF-8 \
    LANG=C.UTF-8 \
    PYTHONUNBUFFERED="1"

RUN useradd -mU mcp

# Install Chromium and dependencies for botasaurus browser automation
RUN apt -y update && \
    apt -y upgrade && \
    apt -y install --no-install-recommends \
      chromium \
      chromium-driver \
      libglib2.0-0 \
      libnss3 \
      libdbus-1-3 \
      libatk1.0-0 \
      libatk-bridge2.0-0 \
      libcups2 \
      libexpat1 \
      libx11-6 \
      libxcomposite1 \
      libxdamage1 \
      libxext6 \
      libxfixes3 \
      libxrandr2 \
      libgbm1 \
      libxcb1 \
      libxkbcommon0 \
      libpango-1.0-0 \
      libcairo2 \
      libasound2 \
      libatspi2.0-0 \
      fonts-liberation \
      xdg-utils && \
    apt -y clean && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /home/mcp
RUN pip install uv

# Copy files as root first, then change ownership
COPY uv.lock pyproject.toml /home/mcp/
RUN chown -R mcp:mcp /home/mcp

USER mcp

RUN uv sync

COPY --chown=mcp:mcp src/botasaurus_server.py /home/mcp/src/

CMD ["uv", "run", "fastmcp", "run", "src/botasaurus_server.py"]
